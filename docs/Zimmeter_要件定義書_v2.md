# 業務時間計測・管理システム 要件定義書 (v2)

**Version**: 2.0
**Date**: 2024-12-18

## 1. プロジェクト概要

### 1.1 システム名
業務時間計測・統合管理システム (Time Tracker & Management System)

### 1.2 目的
業務時間の正確な計測による「業務の見える化」、厳格なユーザー管理権限による統制、および日次の勤務状態（出社・退社）の管理を行う。

### 1.3 運用・技術環境
*   **Frontend**: React (Vite) + Tailwind CSS
*   **Backend**: Node.js + Express
*   **Database**: PostgreSQL + Prisma
*   **Container**: Docker Compose

---

## 2. データベース要件 (重要ロジック)

本システムの根幹となるデータ構造の定義。v2では「勤務状態管理」が追加された。

### 2.1 スキーマ定義のポイント
*   **UserStatus**: ユーザーの利用可否状態 (ACTIVE / DISABLED / DELETED)。
*   **CategoryType**: 業務項目の種別 (SYSTEM: 全員 / CUSTOM: 個人)。
*   **Snapshot**: ログ記録時点のカテゴリ名を保存し、マスタ変更による過去履歴の改変を防ぐ。
*   **DailyStatus (New)**: ユーザーごとの日次ステータス（勤務中、退社済、未退社、補正済）を管理する。

---

## 3. 機能要件

### 3.1 業務分析・履歴機能
1.  **User履歴ダウンロード機能 (CSV/PDF)**
    *   **入力**: 対象期間（任意指定 / カスタム）、ユーザーID（複数選択可）。
    *   **出力**: 日時、ユーザー名、**業務項目名（スナップショット）**、所要時間、日次ステータスを含むCSVファイル。
    *   **PDF出力**: 当日の業務日報としてPDFダウンロードも可能。
2.  **業務実績グラフ表示**
    *   **期間切り替え**: 日別 / 週別 / 月別 / **年別 (New)** / **カスタム期間 (New)**。
    *   **マルチユーザー集計 (New)**: 複数のユーザーを選択し、合算した業務時間の内訳をグラフ化する機能。
    *   **可視化**: 期間内の業務項目ごとの作業時間割合を円グラフ/棒グラフで表示。拡大プレビュー機能対応。
3.  **全ユーザー直近監視 (Monitor)**
    *   **対象**: 全ユーザーの最新アクティビティ。
    *   **フィルタ (New)**: ユーザーの複数選択フィルタリング、期間指定（直近24H、週間、月間、年間、カスタム）。
    *   **表示内容**:
        *   ユーザー基本情報
        *   現在のタスク・経過時間
        *   **日次ステータス**: 「勤務中」「未退社」「退社済」「退社済(補正済)」を表示。
        *   編集履歴の有無。

### 3.2 勤務状態管理機能 (New)
*   **退社処理**: ユーザーは業務終了時に「退社」状態を記録できる。
*   **自動判定**: ログの記録状況と現在時刻から、リアルタイムに「勤務中」か「未退社（日を跨いで放置）」かを判定する。
*   **補正機能**: 過去の日付に対して、管理者が後追いでステータスを修正（補正）できる。

### 3.3 業務項目（カテゴリ）管理機能
1.  **権限分離**
    *   **SYSTEMカテゴリ**: 管理者(Admin)のみ操作可能。
    *   **CUSTOMカテゴリ**: 一般ユーザー(User)が自身用に作成。
2.  **履歴保全**
    *   項目名を変更しても、過去のログ（スナップショット）は維持される。
    *   削除は論理削除 (`isDeleted`) とし、選択肢からのみ非表示にする。

### 3.4 ユーザー管理機能 (管理者専用)
1.  **ユーザー一覧・検索・一括操作**
    *   ID、氏名、現在のステータスを表示。
2.  **ステータス変更（Status Guard）**
    *   **無効化 (Disable)** / **削除 (Delete)** されたユーザーは、即座に画面操作がロックされる（ポーリング監視）。

---

## 4. 非機能要件 (UI/UX)

### 4.1 状態変化時の強制ロック (Status Guard)
管理者がステータスを変更した際、対象ユーザーのブラウザ画面を即座にオーバーレイでロックし、操作を不能にする。

### 4.2 通知UI
*   トースト通知による操作完了フィードバック。
*   管理者による情報変更時のリアルタイム通知。

### 4.3 レポート出力
*   **CSV**: Excel等での利用を想定し、BOM付きUTF-8で出力。
*   **JST対応**: サーバー内部(UTC)と表示(JST)のタイムゾーン変換を厳密に行う。
