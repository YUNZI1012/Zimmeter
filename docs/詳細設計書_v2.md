# 業務時間計測・管理システム (Zimmeter) 詳細設計書

**Version**: 2.0
**Date**: 2024-12-18

## 1. システム構成

### 1.1 アーキテクチャ
*   **クライアントサイド**: Single Page Application (SPA)
    *   Framework: React (Vite)
    *   Styling: Tailwind CSS
    *   State Management: React Query (TanStack Query) + Context API
    *   HTTP Client: Axios
*   **サーバーサイド**: RESTful API Server
    *   Runtime: Node.js
    *   Framework: Express
    *   ORM: Prisma
*   **データベース**: Relational Database
    *   Engine: PostgreSQL

### 1.2 ディレクトリ構成 (抜粋)
```
Zimmeter/
├── client/                 # Frontend
│   ├── src/
│   │   ├── components/     # React Components
│   │   │   ├── Admin/      # 管理者画面用コンポーネント
│   │   │   ├── Common/     # 共通コンポーネント
│   │   │   └── ...
│   │   ├── context/        # Context Providers (Toast等)
│   │   ├── lib/            # Utilities, Axios instance
│   │   └── pages/          # Page Components (AdminPage, UserPage)
│   └── ...
├── server/                 # Backend
│   ├── src/
│   │   ├── routes_v2.ts    # API Routes definition
│   │   ├── server.ts       # Server entry point
│   │   └── ...
│   ├── prisma/
│   │   └── schema.prisma   # DB Schema definition
│   └── ...
└── docker-compose.yml      # Container orchestration
```

---

## 2. API設計 (主要エンドポイント)

### 2.1 認証・ユーザー管理
| Method | Endpoint | Description | Auth |
| :--- | :--- | :--- | :--- |
| GET | `/api/users` | ユーザー一覧取得 (管理用) | Admin |
| POST | `/api/users` | 新規ユーザー作成 | Admin |
| PUT | `/api/users/:id` | ユーザー情報更新 | Admin |
| PATCH | `/api/users/:id/status` | ユーザーステータス変更 (Active/Disabled/Deleted) | Admin |
| POST | `/api/auth/login` | ログイン (ID/Pass検証) | Public |
| GET | `/api/users/me` | 自身のユーザー情報取得 | User/Admin |

### 2.2 カテゴリ管理
| Method | Endpoint | Description | Auth |
| :--- | :--- | :--- | :--- |
| GET | `/api/categories` | カテゴリ一覧取得 (System + Own Custom) | All |
| POST | `/api/categories` | カテゴリ作成 (Admin->System, User->Custom) | All |
| PUT | `/api/categories/:id` | カテゴリ更新 | Owner |
| DELETE | `/api/categories/:id` | カテゴリ論理削除 | Owner |

### 2.3 ログ・業務管理
| Method | Endpoint | Description | Auth |
| :--- | :--- | :--- | :--- |
| POST | `/api/logs/switch` | タスク切り替え (進行中を終了し新規開始) | All |
| PUT | `/api/logs/:id` | ログ修正 (時間、カテゴリ等) | Owner |
| POST | `/api/logs` | ログ手動追加 | All |
| GET | `/api/logs/history` | 自身のログ履歴取得 | All |
| POST | `/api/logs/leave` | 退社処理 (進行中タスク終了 + 日次ステータス更新) | All |
| POST | `/api/logs/check` | 状態チェック (未退社判定など) | All |

### 2.4 管理者モニタリング・集計
| Method | Endpoint | Description | Auth |
| :--- | :--- | :--- | :--- |
| GET | `/api/logs/monitor` | 全ユーザーのログ監視・集計取得 | Admin |
| GET | `/api/status/monitor` | 全ユーザーの日次ステータス取得 | Admin |
| GET | `/api/logs/stats` | 統計データ取得 (グラフ用) | Admin |
| GET | `/api/export/csv` | CSVエクスポート | Admin |
| GET | `/api/export/pdf` | PDFエクスポート (日報) | All |

### 2.5 設定
| Method | Endpoint | Description | Auth |
| :--- | :--- | :--- | :--- |
| GET | `/api/settings` | ユーザー設定取得 | All |
| POST | `/api/settings` | ユーザー設定保存 | All |

---

## 3. 主要ロジック詳細

### 3.1 ログ記録とスナップショット
*   **仕組み**: `WorkLog` 作成時、選択された `Category` の `name` を `categoryNameSnapshot` カラムにコピーする。
*   **目的**: 後にマスタのカテゴリ名が変更されたり、カテゴリ自体が削除されても、過去のログには「その作業を行った当時の名称」を残すため。
*   **表示**: 履歴画面やCSV出力では、常に `categoryNameSnapshot` を優先して表示する。

### 3.2 経過時間の計算
*   **進行中のタスク**: DB上の `startTime` と現在時刻 (`Date.now()`) の差分をクライアントサイドで計算し、リアルタイム表示（1秒更新）する。
*   **完了したタスク**: `endTime` - `startTime` で `duration` (秒) を確定し、DBに保存する。

### 3.3 モニタリング・ステータス判定
管理者画面 (`MonitorTable`) では、ユーザーごとに以下のようなロジックでステータスを表示する。
1.  **退社済**: `DailyStatus` テーブルの `hasLeft` が `true` の場合。
2.  **勤務中**: 当日のログがあり、最後のログに `endTime` が設定されていない（進行中）場合。
3.  **未退社**:
    *   過去日において、最後のログが進行中のまま残っている場合。
    *   または `DailyStatus` の `hasLeft` が `false` のまま日付が変わった場合。
4.  **補正済**: `DailyStatus` の `isFixed` が `true` の場合（管理者が手動修正、またはユーザーが翌日に未退社処理を行った場合など）。

### 3.4 CSVエクスポート仕様
*   **フォーマット**: BOM付きUTF-8 CSV (Excel対応)。
*   **出力項目**:
    *   Time (開始時刻)
    *   User (氏名)
    *   Role (権限)
    *   UID (ログインID)
    *   Daily Status (日付 + 退社/未退社等の状態)
    *   Task (カテゴリ名スナップショット)
    *   Type (通常/作成済/変更済)
    *   Mod Time (変更日時)
    *   Duration (作業時間)
*   **対象**: フィルタリング条件（期間、ユーザーID）に合致するデータを抽出。

---

## 4. UIコンポーネント設計 (Frontend)

### 4.1 共通コンポーネント
*   **Sidebar**: ユーザー情報表示、ナビゲーション（Admin/User切り替え）、ログアウト機能。
*   **StatusGuard**: ユーザーのステータス（DISABLED/DELETED）を監視し、該当する場合は全画面オーバーレイで操作をブロックする高階コンポーネント (HOC) またはラッパー。
*   **ChartWrapper / ChartPreviewModal**: グラフ表示と拡大プレビュー機能を提供。

### 4.2 管理者ページ (AdminPage)
*   **MonitorTable**: 全ユーザーのアクティビティを一覧表示。CSVダウンロード機能を含む。
*   **AdminWorkLogCharts**: ユーザー別の業務割合をパイチャートで表示。
*   **UserList**: ユーザーの登録・編集・ステータス変更を行う管理テーブル。
*   **ProjectManagement**: システムカテゴリの管理を行う。

### 4.3 ユーザーページ (UserPage)
*   **TaskButton**: 業務カテゴリを選択するボタン。進行中はアクティブ表示。
*   **TodayHistoryBar**: 当日のタイムラインをバーで視覚的に表示。
*   **HistoryModal**: 過去の履歴一覧を表示・編集するモーダル。
*   **SettingsModal**: カテゴリの並び替えや表示設定を行うモーダル。
