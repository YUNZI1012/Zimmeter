# 業務時間計測・管理システム 要件定義書 (最終確定版)

**Version**: 1.0 (Fixed)
**Date**: 2024-XX-XX

## 1. プロジェクト概要

### 1.1 システム名
業務時間計測・統合管理システム (Time Tracker & Management System)

### 1.2 目的
業務時間の正確な計測による「業務の見える化」、および厳格なユーザー管理権限による統制を行う。

### 1.3 運用・技術環境
*   **Frontend**: React (Vite) + Tailwind CSS (Port: `9002`)
*   **Backend**: Node.js + Express (Port: `9102`)
*   **Database**: PostgreSQL + Prisma (Port: `55002`)
*   **運用期間**: 2週間（トライアル）

---

## 2. データベース要件 (重要ロジック)

本システムの根幹となるデータ構造の定義。特に「履歴の保全」と「ユーザー状態管理」が重要となる。

### 2.1 スキーマ定義 (Prisma)
```prisma
enum UserStatus {
  ACTIVE   // 通常 (利用可)
  DISABLED // 無効化 (ログイン不可 / 画面グレーアウトロック)
  DELETED  // 削除 (ログイン不可 / 画面赤色ロック / 再登録不可)
}

enum CategoryType {
  SYSTEM // 管理者のみ作成・編集可能 (全ユーザー共通)
  CUSTOM // 一般ユーザーが作成 (自分のみ利用・編集可能)
}

model WorkLog {
  // ... (id, dates)
  
  // カテゴリマスタが削除/変更されても、過去のログの表記が変わらないよう
  // 記録時点のカテゴリ名を「スナップショット」として文字列保存する
  categoryNameSnapshot String 
  
  // マスタとの紐付け (集計用、マスタ削除時はNULLまたはID維持)
  categoryId Int?
}
```

## 3. 機能要件

### 3.1 業務分析・履歴機能
1.  **User履歴ダウンロード機能 (CSV)**
    *   **入力**: 対象期間（YYYY/MM/DD ～ YYYY/MM/DD）、ユーザーID（管理者の場合）。
    *   **出力**: 日時、ユーザー名、**業務項目名（スナップショット）**、所要時間を含むCSVファイル。
    *   **要件**: 
        *   ダウンロード対象の期間（開始日～終了日）を任意に選択できること。
        *   ダウンロード時に最新のマスタ名ではなく、記録当時の作業名が出力されること（履歴の改変防止）。
2.  **業務実績グラフ表示**
    *   **切り替え**: 日別 / 週別 / 月別の集計切り替え。
    *   **可視化**: 期間内の業務項目ごとの作業時間割合を円グラフで表示。
3.  **全ユーザー直近監視 (Monitor)**
    *   **対象**: 全ユーザーの最新アクティビティ（直近24時間以内のログなど）。
    *   **表示**: 時系列順（最新が一番上）でリスト表示し、異常値（長時間放置、深夜稼働、誤操作）を管理者が早期に発見可能にする。

### 3.2 業務項目（カテゴリ）管理機能
1.  **権限分離**
    *   **SYSTEMカテゴリ**: 管理者(Admin)のみ新規登録・編集・削除が可能。一般ユーザーは使用のみ可能。
    *   **CUSTOMカテゴリ**: 一般ユーザー(User)自身のみ登録・編集・削除が可能。他人のカスタム項目は見えない。
2.  **編集・削除の挙動**
    *   **編集**: 項目名の修正は**今後記録されるログ**にのみ反映する。過去のログ名称（スナップショット）は書き換えない。
    *   **削除**: **論理削除** (`isDeleted = true`) を採用する。
        *   新規記録時の選択肢からは消える。
        *   データベース上には残り、過去ログの参照整合性を保つ（過去のグラフやCSVには残る）。

### 3.3 ユーザー管理機能 (管理者専用)
1.  **ユーザー一覧・検索**
    *   ID、氏名、現在のステータスを表示。
2.  **ユーザー編集**
    *   氏名、権限、標準単価などの情報を更新する。
    *   **通知**: 更新完了後、画面上に「ユーザー [氏名] の情報を更新しました」とトースト通知（Popup）を表示する。
3.  **ステータス変更（無効化・削除）**
    *   **無効化 (Disable)**: 一時的な停止。管理者が再度「ACTIVE」に戻すことで復帰可能。
    *   **削除 (Delete)**: 永久的な停止扱い。データ（ログ）は残すが、復帰運用は想定しない（再登録が必要）。

---

## 4. 非機能要件 (UI/UX)

### 4.1 状態変化時の強制ロック (Status Guard)
管理者がユーザーのステータスを変更した際、対象ユーザーのブラウザ画面に対し、**即座に（数秒以内に）** 以下の制御を行う。

*   **無効化された場合 (DISABLED)**:
    *   **画面効果**: 画面全体を「半透明の黒（グレーアウト）」で覆う。
    *   **メッセージ**: 中央に**「ユーザーを無効化しました。管理者に問い合わせてください。」**と表示。
    *   **操作制限**: ボタンクリック等、一切の操作をブロックする。
*   **削除された場合 (DELETED)**:
    *   **画面効果**: 画面全体を「半透明の赤（レッドアウト）」で覆う。
    *   **メッセージ**: 中央に**「ユーザーを削除しました。」**と表示。
    *   **操作制限**: ボタンクリック等、一切の操作をブロックする。

### 4.2 通知UI (Toast Notification)
*   **Admin側**: ユーザー情報の編集保存時やステータス変更時に、完了メッセージを表示する。
*   **User側**: 管理者により自分の情報が変更された際（ポーリングで検知）、「管理者により情報が更新されました」と表示する。

---

## 5. API設計方針 (REST Endpoints)

| メソッド | パス | 権限 | 機能概要 |
| :--- | :--- | :--- | :--- |
| **GET** | `/api/users` | Admin | ユーザー一覧取得 |
| **GET** | `/api/users/me` | All | 自分の情報取得（ステータス監視・ポーリング用） |
| **PUT** | `/api/users/:id` | Admin | ユーザー情報編集 (通知トリガー) |
| **PATCH** | `/api/users/:id/status` | Admin | ステータス変更 (Active/Disabled/Deleted) |
| **GET** | `/api/categories` | All | カテゴリ一覧 (System + 自分のCustom) |
| **POST** | `/api/categories` | All | カテゴリ作成 (RoleによるType自動判定) |
| **PUT** | `/api/categories/:id` | Owner | カテゴリ名変更 (Snapshotには干渉しない) |
| **DELETE** | `/api/categories/:id` | Owner | カテゴリ削除 (論理削除) |
| **POST** | `/api/logs/switch` | All | タスク切り替え & 記録 (Snapshot保存) |
| **GET** | `/api/logs/monitor` | Admin | 全ユーザーの直近ログ一覧監視 |
| **GET** | `/api/stats/summary` | All | グラフ用集計データ取得 |
| **GET** | `/api/stats/export` | All | 履歴CSVダウンロード (Stream出力) |