# 業務時間計測・管理システム (Zimmeter) 要件定義書

**Version**: 3.0
**Date**: 2025-12-22

---

## 1. プロジェクト概要

### 1.1 システム名
業務時間計測・統合管理システム（Zimmeter）

### 1.2 目的
- 業務時間の正確な計測により、業務の見える化を行う。
- 管理者が全ユーザーの稼働状況と実績を把握し、分析・レポート出力できるようにする。
- ユーザーの権限（Role）と状態（UserStatus）を厳格に管理し、無効化・削除ユーザーのアクセスを遮断する。

### 1.3 想定利用者
- **一般ユーザー（USER）**: 自分の業務計測・履歴閲覧・修正・カテゴリ（Custom）管理を行う。
- **管理者（ADMIN）**: 全ユーザーの監視、集計、エクスポート、ユーザー管理、システムカテゴリ管理を行う。

### 1.4 システム構成（現行）
- **Frontend**: React (Vite) + Tailwind CSS + TanStack Query
- **Backend**: Node.js + Express + Prisma
- **Database**: PostgreSQL
- **Container**: Docker / Docker Compose

### 1.5 認証・識別方針（現行）
- 簡易認証として、以下のいずれかでユーザーを識別する。
  - URLパラメータ: `?uid={uid}`
  - リクエストヘッダー: `x-user-id: {uid}`
- `uid` が存在しない場合は、ユーザーコンテキストなしとして扱う（エンドポイント側で要求する場合はエラー）。
- `uid` が存在し、DBにユーザーが存在しない場合は自動生成される（MVP運用）。

---

## 2. 用語定義

- **カテゴリ**: 業務項目（タスク）。System（全体共通）とCustom（個人用）の2種類。
- **WorkLog**: 業務の計測ログ。開始時刻・終了時刻・所要時間を持つ。
- **スナップショット（categoryNameSnapshot）**: ログ作成時点のカテゴリ名を文字列保存し、後からカテゴリ名が変更されても過去の履歴表記が変わらないようにする。
- **DailyStatus**: 日次の退社状態（hasLeft）と補正状態（isFixed）を管理する。

---

## 3. 機能要件

### 3.1 一般ユーザー機能（USER）

#### 3.1.1 業務計測（開始・切替・停止）
- カテゴリボタンをクリックして計測を開始できる。
- 進行中のタスクがある場合、新しいタスクへの切替時は確認ダイアログを表示し、承認した場合は切替を実行できる。
- 停止ボタンにより、進行中タスクを終了できる。

#### 3.1.2 当日履歴の閲覧
- 当日のログを一覧表示できる。
- 当日のタイムラインを視覚的に確認できる（バー表示）。

#### 3.1.3 履歴の編集・削除・手動追加
- 過去ログの開始・終了時刻、カテゴリを編集できる。
- 不要なログを削除できる。
- ログを手動追加できる（手動作成フラグにより区別）。

#### 3.1.4 退社（業務終了）
- 退社ボタンにより、当日の業務終了処理を実行できる。
- 退社処理では、進行中タスクがある場合は停止処理を行った上で、日次ステータスを退社済みに更新する。

#### 3.1.5 退社取消（業務再開）
- 当日中は、退社を取り消して業務を再開できる。

#### 3.1.6 未退社・未停止の補正
- システムは補正が必要な日を自動検出し、ユーザーに補正を促す。
  - 例: 跨日未停止タスク、退社記録のない日
- ユーザーは補正対象日の退社時間を入力し、補正を確定できる。

#### 3.1.7 カテゴリ管理（Custom）
- 自分専用のカテゴリ（Custom）を作成・編集・論理削除できる。
- 表示順序（priority）を変更できる。
- 初期表示先（defaultList）を設定できる（PRIMARY/SECONDARY/HIDDEN）。
- 表示の色（背景色、枠線色）を設定できる。

#### 3.1.8 設定（UI設定）
- カテゴリボタンの表示（メイン/サブ/非表示）などの設定を保存できる。

---

### 3.2 管理者機能（ADMIN）

#### 3.2.1 全ユーザー監視（Monitor）
- 指定期間のログを一覧取得し、ユーザー別に監視できる。
- フィルタ条件
  - 期間: daily / weekly / monthly / custom
  - ユーザー: 単体/複数選択

#### 3.2.2 業務分析（統計）
- 指定期間・指定ユーザー（複数）に対して、
  - 時系列の合計時間（棒グラフ等）
  - カテゴリ別割合（円グラフ等）
  を取得できる。
- 期間モード
  - day / week / month / year / custom

#### 3.2.3 エクスポート
- CSVエクスポート
  - 当日分（ユーザー自身）
  - 期間・ユーザー指定（管理者）
- PDFエクスポート
  - 当日分（ユーザー自身、閲覧専用を想定）

#### 3.2.4 ユーザー管理
- ユーザー一覧を取得できる。
- ユーザー情報（氏名、Role、時給単価）を更新できる。
- ユーザーステータスを変更できる（ACTIVE / DISABLED / DELETED）。
- 最低1名の有効な管理者が存在する制約を満たすよう、最後の管理者の無効化・削除・権限剥奪を防止する。

#### 3.2.5 システムカテゴリ管理
- 全ユーザー共通のカテゴリ（System）を作成・編集・論理削除できる。

---

## 4. 非機能要件

### 4.1 タイムゾーン要件
- 日次の判定（当日0:00区切り、退社状態、当日履歴）は **JST（UTC+9）** を基準とする。

### 4.2 信頼性・保全性
- カテゴリ名変更による履歴改変を防ぐため、`categoryNameSnapshot` を必須とする。
- ユーザー・カテゴリの削除は原則論理削除（状態/フラグ）とし、過去ログの整合性を保持する。

### 4.3 セキュリティ（運用前提）
- RBAC（Role）により管理者機能へのアクセスを制限する。
- `UserStatus` が DISABLED/DELETED のユーザーは、APIレベルでアクセスを拒否する。

### 4.4 ユーザビリティ
- 操作に対してToast等でフィードバックを提供する。
- PC/タブレットでの利用を想定したレスポンシブUIとする。

---

## 5. 対象外（今後の検討）
- パスワード等を用いた強固な認証方式（現行は簡易識別）。
- 監査ログ（誰がいつ何を変更したか）の永続化。
- 多拠点タイムゾーン対応。
