# 業務時間計測・管理システム (Zimmeter) 詳細設計書

**Version**: 3.0
**Date**: 2025-12-22

---

## 1. システム構成

### 1.1 アーキテクチャ
- **クライアント**: React (Vite)
  - UI: Tailwind CSS
  - データ取得: TanStack Query + Axios
- **サーバー**: Node.js + Express
  - API: REST
  - 認証（識別）: `uid`（URLパラメータ / ヘッダー）
- **DB**: PostgreSQL
  - ORM: Prisma

### 1.2 ディレクトリ構成（主要）
```
Zimmeter/
├── client/
│   └── src/
│       ├── App_v2.tsx
│       ├── components/
│       ├── hooks/
│       └── lib/
├── server/
│   ├── src/
│   │   ├── server.ts
│   │   ├── routes_v2.ts
│   │   └── middleware/auth.ts
│   └── prisma/
│       ├── schema.prisma
│       └── seed.ts
└── docker-compose.yml
```

---

## 2. 認証・認可（現行実装）

### 2.1 ユーザー識別
- クライアントは、以下のいずれかで `uid` をサーバへ送る。
  - URL: `?uid={uid}`
  - Header: `x-user-id: {uid}`

### 2.2 Status Guard（共通ミドルウェア）
- `server/src/middleware/auth.ts` の `statusGuard` を、全API（`/api`）に適用。
- 処理概要
  - `uid` を取得し `users` を検索
  - 未存在なら自動作成（MVP）
  - `User.status` が `DISABLED` / `DELETED` の場合は 403 を返す
  - それ以外は `req.user` にユーザー情報を設定

---

## 3. API設計（現行 `routes_v2.ts`）

### 3.1 ユーザー管理（Admin）
- **GET** `/api/users`
  - 権限: ADMIN
  - 概要: ユーザー一覧取得

- **GET** `/api/users/me`
  - 権限: USER/ADMIN
  - 概要: 自分のユーザー情報取得（ポーリング等に使用）

- **PUT** `/api/users/:id`
  - 権限: ADMIN
  - 概要: 氏名・Role・時給の更新

- **PATCH** `/api/users/:id/status`
  - 権限: ADMIN
  - 概要: `ACTIVE/DISABLED/DELETED` への状態変更
  - 備考: 最低1名の有効管理者が存在する制約の考慮あり

---

### 3.2 カテゴリ管理
- **GET** `/api/categories`
  - 権限: USER/ADMIN
  - 概要: SYSTEMカテゴリ + 自分のCUSTOMカテゴリを取得

- **POST** `/api/categories`
  - 権限: USER/ADMIN
  - 概要: カテゴリ作成
  - 備考: SYSTEM作成はADMINのみ

- **PUT** `/api/categories/:id`
  - 権限: Owner（SYSTEMはADMIN、CUSTOMは作成者）
  - 概要: 名称・表示順・色・defaultList等の更新

- **PUT** `/api/categories/reorder`
  - 権限: USER/ADMIN
  - 概要: priority（およびdefaultList）を一括更新

- **DELETE** `/api/categories/:id`
  - 権限: Owner（SYSTEMはADMIN、CUSTOMは作成者）
  - 概要: 論理削除（`isDeleted=true`）

---

### 3.3 ログ操作（計測）
- **GET** `/api/logs/active`
  - 概要: 現在進行中（`endTime=null`）のログ取得

- **POST** `/api/logs/switch`
  - 概要: タスク切替
  - 処理
    - 進行中ログがあれば終了（`endTime`/`duration`更新）
    - 新規ログ作成（`categoryNameSnapshot` を保存）

- **POST** `/api/logs/stop`
  - 概要: 進行中ログの停止

- **GET** `/api/logs/history`
  - 概要: 当日（JST 00:00基準）ログ取得
  - 備考: JSTの開始時刻をUTCに変換して抽出

- **POST** `/api/logs/manual`
  - 概要: 手動ログ追加

- **PATCH** `/api/logs/:id`
  - 概要: ログ編集（カテゴリ・開始/終了）

- **DELETE** `/api/logs/:id`
  - 概要: ログ削除

---

### 3.4 退社・補正（ステータス）
- **GET** `/api/status/today`
  - 概要: 本日の退社状態

- **POST** `/api/status/leave`
  - 概要: 退社処理
  - 処理
    - 進行中ログがあれば停止
    - `daily_statuses` を `hasLeft=true` で更新
    - 早朝（<5時）に当日ログが無い場合、退社を前日に帰属させるロジックあり

- **POST** `/api/status/resume`
  - 概要: 退社取消
  - 備考: `hasLeft=true` の最新 `DailyStatus` を解除

- **GET** `/api/status/check`
  - 概要: 補正が必要な日付を自動検出
  - 優先
    - 跨日未停止タスクがあれば、その開始日を返却
    - 直近一定期間内で、ログが存在し `hasLeft=false` かつ `isFixed=false` の日を返却

- **POST** `/api/status/fix`
  - 概要: 過去日の補正
  - 入力: `date`, `leaveTime`（ISO）, `hasLeft`（任意）

- **GET** `/api/status/monitor`
  - 権限: ADMIN
  - 概要: 期間指定で `DailyStatus` を取得

---

### 3.5 管理者向けログ監視・集計
- **GET** `/api/logs/monitor`
  - 権限: ADMIN
  - 概要: 指定期間・ユーザーのログ取得
  - Query: `range`, `userIds`, `start`, `end`

- **GET** `/api/logs/stats`
  - 権限: ADMIN
  - 概要: 時系列 + カテゴリ別集計を返却
  - Query: `mode`, `userId/userIds`, `start`, `end`

---

### 3.6 エクスポート
- **GET** `/api/export/csv`
  - 用途が2系統存在
    - 当日分（ユーザー自身、日報）
    - 期間・ユーザー指定（管理用途）

- **GET** `/api/export/pdf`
  - 概要: 当日分のPDF日報出力

---

### 3.7 設定
- **GET** `/api/settings`
  - 概要: `user_settings` 取得

- **POST** `/api/settings`
  - 概要: `user_settings` 保存（preferences）

- **DELETE** `/api/settings`
  - 概要: 設定リセット

---

## 4. 主要フロー（テキスト）

### 4.1 計測開始→切替→停止
1. ユーザーがカテゴリを選択
2. `/api/logs/switch` を呼び出し
3. 既存の進行中ログがあれば終了し、新規ログを作成
4. UIは `/api/logs/active` と `/api/logs/history` をポーリングし表示を更新

### 4.2 退社
1. ユーザーが退社を実行
2. `/api/status/leave` を呼び出し
3. 進行中ログがあれば終了
4. `daily_statuses` に退社状態を記録

### 4.3 未退社/未停止の検出と補正
1. アプリ起動時または所定タイミングで `/api/status/check`
2. `needsFix=true` の場合、補正モーダルを表示
3. ユーザーが退社時刻を入力し `/api/status/fix`

---

## 5. 例外・エラーハンドリング方針
- `statusGuard` により、DISABLED/DELETED ユーザーは 403 を返す。
- 入力値不正（ID不足、日付不正等）は 400 を返す。
- 予期しない例外は 500 を返す。

---

## 6. 補足
- DB仕様は `docs/DB定義書_v3.md` を参照。
- 要件は `docs/要件定義書_v3.md` を参照。
